[Nest] 10748  - 02/17/2026, 10:08:40 AM     LOG [BillingService] Creating bill for tenant 65def42f-e1fa-4fed-83d0-1c832c6b8180 by user de046be5-6a17-47ca-a6bf-4da028d9bd5d
[Nest] 10748  - 02/17/2026, 10:08:40 AM     LOG [BillingService] === BILL CREATION STARTED ===
[Nest] 10748  - 02/17/2026, 10:08:40 AM     LOG [BillingService] Data fetch completed in 439ms (0 DB queries, 1 cached)
[Nest] 10748  - 02/17/2026, 10:08:40 AM     LOG [BillingService] Starting database transaction...
prisma:query BEGIN
prisma:query DEALLOCATE ALL
prisma:query SELECT "public"."bills"."id", "public"."bills"."tenant_id", "public"."bills"."user_id", "public"."bills"."kot_id", "public"."bills"."bill_number", "public"."bills"."subtotal", "public"."bills"."tax_amount", "public"."bills"."discount", "public"."bills"."total_amount", "public"."bills"."payment_method"::text, "public"."bills"."payment_status", "public"."bills"."order_type"::text, "public"."bills"."status"::text, "public"."bills"."customer_name", "public"."bills"."customer_phone", "public"."bills"."notes", "public"."bills"."billed_at", "public"."bills"."created_at", "public"."bills"."updated_at", "public"."bills"."cancelled_at" FROM "public"."bills" WHERE ("public"."bills"."tenant_id" = $1 AND "public"."bills"."bill_number"::text LIKE $2) ORDER BY "public"."bills"."bill_number" DESC LIMIT $3 OFFSET $4
[Nest] 10748  - 02/17/2026, 10:08:43 AM     LOG [BillingService] Bill number generated in 409ms
prisma:query INSERT INTO "public"."bills" ("id","tenant_id","user_id","kot_id","bill_number","subtotal","tax_amount","discount","total_amount","payment_method","payment_status","order_type","status","billed_at","created_at","updated_at") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,CAST($10::text AS "public"."PaymentMethod"),$11,CAST($12::text AS "public"."OrderType"),CAST($13::text AS "public"."BillStatus"),$14,$15,$16) RETURNING "public"."bills"."id", "public"."bills"."tenant_id", "public"."bills"."user_id", "public"."bills"."kot_id", "public"."bills"."bill_number", "public"."bills"."subtotal", "public"."bills"."tax_amount", "public"."bills"."discount", "public"."bills"."total_amount", "public"."bills"."payment_method"::text, "public"."bills"."payment_status", "public"."bills"."order_type"::text, "public"."bills"."status"::text, "public"."bills"."customer_name", "public"."bills"."customer_phone", "public"."bills"."notes", "public"."bills"."billed_at", "public"."bills"."created_at", "public"."bills"."updated_at", "public"."bills"."cancelled_at"
[Nest] 10748  - 02/17/2026, 10:08:44 AM     LOG [BillingService] Bill created in 409ms
prisma:query INSERT INTO "public"."bill_items" ("gst_rate","quantity","item_id","created_at","price","bill_id","gst_amount","total_amount","updated_at","id") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10)
prisma:query SELECT "public"."bill_items"."id", "public"."bill_items"."bill_id", "public"."bill_items"."item_id", "public"."bill_items"."quantity", "public"."bill_items"."price", "public"."bill_items"."gst_rate", "public"."bill_items"."gst_amount", "public"."bill_items"."total_amount", "public"."bill_items"."created_at", "public"."bill_items"."updated_at" FROM "public"."bill_items" WHERE "public"."bill_items"."bill_id" = $1 ORDER BY "public"."bill_items"."created_at" ASC OFFSET $2
[Nest] 10748  - 02/17/2026, 10:08:45 AM     LOG [BillingService] Bill items created in 1023ms
prisma:query 
      SELECT id, current_quantity as "currentQuantity", cost_price as "costPrice", purchase_date as "purchaseDate"
      FROM inventory_batches
      WHERE tenant_id = $1
        AND item_id = $2
        AND current_quantity > 0
      ORDER BY purchase_date ASC
      FOR UPDATE
    
prisma:query UPDATE "public"."inventory_batches" SET "current_quantity" = ("public"."inventory_batches"."current_quantity" - $1), "updated_at" = $2 WHERE ("public"."inventory_batches"."id" = $3 AND 1=1) RETURNING "public"."inventory_batches"."id", "public"."inventory_batches"."tenant_id", "public"."inventory_batches"."item_id", "public"."inventory_batches"."purchase_id", "public"."inventory_batches"."batch_number", "public"."inventory_batches"."initial_quantity", "public"."inventory_batches"."current_quantity", "public"."inventory_batches"."cost_price", "public"."inventory_batches"."purchase_date", "public"."inventory_batches"."expiry_date", "public"."inventory_batches"."created_at", "public"."inventory_batches"."updated_at"
[Nest] 10748  - 02/17/2026, 10:08:45 AM     LOG [InventoryService] Deducted inventory for item 3a8dae78-b706-4c80-b8d1-35dde51e4748: 1 batches updated
prisma:query INSERT INTO "public"."bill_item_batches" ("bill_item_id","created_at","cost_price","id","batch_id","quantity_used") VALUES ($1,$2,$3,$4,$5,$6)
[Nest] 10748  - 02/17/2026, 10:08:46 AM     LOG [BillingService] Inventory deducted for item Casual Shirt - Blue: 1 units using 1 batches
[Nest] 10748  - 02/17/2026, 10:08:46 AM     LOG [BillingService] Inventory processing completed in 1436ms
prisma:query COMMIT
[Nest] 10748  - 02/17/2026, 10:08:46 AM     LOG [BillingService] Transaction completed in 6144ms
[Nest] 10748  - 02/17/2026, 10:08:46 AM     LOG [BillingService] === TOTAL BILL CREATION TIME: 6584ms ===
prisma:query BEGIN
[Nest] 10748  - 02/17/2026, 10:08:46 AM     LOG [BillingService] Cleared dashboard cache for tenant 65def42f-e1fa-4fed-83d0-1c832c6b8180
prisma:query DEALLOCATE ALL
prisma:query INSERT INTO "public"."audit_logs" ("id","tenant_id","user_id","action","entity","entity_id","before_data","after_data","created_at") VALUES ($1,$2,$3,CAST($4::text AS "public"."AuditAction"),$5,$6,$7,$8,$9) RETURNING "public"."audit_logs"."id", "public"."audit_logs"."tenant_id", "public"."audit_logs"."user_id", "public"."audit_logs"."action"::text, "public"."audit_logs"."entity", "public"."audit_logs"."entity_id", "public"."audit_logs"."before_data", "public"."audit_logs"."after_data", "public"."audit_logs"."ip_address", "public"."audit_logs"."user_agent", "public"."audit_logs"."created_at"
prisma:query COMMIT
[Nest] 10748  - 02/17/2026, 10:08:47 AM     LOG [AuditService] Audit: CREATE Bill bdf95a8c-0e4e-495e-ab3c-6401d6011471 by user de046be5-6a17-47ca-a6bf-4da028d9bd5d in tenant 65def42f-e1fa-4fed-83d0-1c832c6b8180
prisma:query BEGIN
prisma:query DEALLOCATE ALL
prisma:query SELECT "public"."bills"."id", "public"."bills"."tenant_id", "public"."bills"."user_id", "public"."bills"."kot_id", "public"."bills"."bill_number", "public"."bills"."subtotal", "public"."bills"."tax_amount", "public"."bills"."discount", "public"."bills"."total_amount", "public"."bills"."payment_method"::text, "public"."bills"."payment_status", "public"."bills"."order_type"::text, "public"."bills"."status"::text, "public"."bills"."customer_name", "public"."bills"."customer_phone", "public"."bills"."notes", "public"."bills"."billed_at", "public"."bills"."created_at", "public"."bills"."updated_at", "public"."bills"."cancelled_at" FROM "public"."bills" WHERE ("public"."bills"."id" = $1 AND 1=1) LIMIT $2 OFFSET $3
prisma:query SELECT "public"."bill_items"."id", "public"."bill_items"."bill_id", "public"."bill_items"."item_id", "public"."bill_items"."quantity", "public"."bill_items"."price", "public"."bill_items"."gst_rate", "public"."bill_items"."gst_amount", "public"."bill_items"."total_amount", "public"."bill_items"."created_at", "public"."bill_items"."updated_at" FROM "public"."bill_items" WHERE "public"."bill_items"."bill_id" IN ($1) OFFSET $2
prisma:query SELECT "public"."items"."id", "public"."items"."tenant_id", "public"."items"."category_id", "public"."items"."name", "public"."items"."description", "public"."items"."sku", "public"."items"."item_type"::text, "public"."items"."price", "public"."items"."gst_rate", "public"."items"."track_inventory", "public"."items"."inventory_mode"::text, "public"."items"."unit", "public"."items"."is_active", "public"."items"."created_at", "public"."items"."updated_at", "public"."items"."deleted_at" FROM "public"."items" WHERE "public"."items"."id" IN ($1) OFFSET $2
prisma:query SELECT "public"."tenants"."id", "public"."tenants"."name", "public"."tenants"."business_type", "public"."tenants"."gst_number", "public"."tenants"."address", "public"."tenants"."phone", "public"."tenants"."email", "public"."tenants"."inventory_method", "public"."tenants"."currency", "public"."tenants"."timezone", "public"."tenants"."settings", "public"."tenants"."is_active", "public"."tenants"."created_at", "public"."tenants"."updated_at", "public"."tenants"."deleted_at" FROM "public"."tenants" WHERE "public"."tenants"."id" IN ($1) OFFSET $2
prisma:query SELECT "public"."users"."id", "public"."users"."name" FROM "public"."users" WHERE "public"."users"."id" IN ($1) OFFSET $2
prisma:query COMMIT
prisma:query BEGIN
prisma:query DEALLOCATE ALL
prisma:query INSERT INTO "public"."print_jobs" ("id","tenant_id","bill_id","job_type","status","payload","attempts","max_attempts","created_at","updated_at") VALUES ($1,$2,$3,CAST($4::text AS "public"."PrintJobType"),CAST($5::text AS "public"."PrintJobStatus"),$6,$7,$8,$9,$10) RETURNING "public"."print_jobs"."id", "public"."print_jobs"."tenant_id", "public"."print_jobs"."bill_id", "public"."print_jobs"."kot_id", "public"."print_jobs"."job_type"::text, "public"."print_jobs"."status"::text, "public"."print_jobs"."payload", "public"."print_jobs"."attempts", "public"."print_jobs"."max_attempts", "public"."print_jobs"."last_error", "public"."print_jobs"."created_at", "public"."print_jobs"."updated_at", "public"."print_jobs"."completed_at"
prisma:query COMMIT
[Nest] 10748  - 02/17/2026, 10:08:52 AM     LOG [PrintingService] Bill print job queued: 77e312db-9265-464a-9153-d36799f2e9fc for bill BILL202602000011
prisma:query BEGIN
prisma:query DEALLOCATE ALL
prisma:query SELECT "public"."bills"."id", "public"."bills"."tenant_id", "public"."bills"."user_id", "public"."bills"."kot_id", "public"."bills"."bill_number", "public"."bills"."subtotal", "public"."bills"."tax_amount", "public"."bills"."discount", "public"."bills"."total_amount", "public"."bills"."payment_method"::text, "public"."bills"."payment_status", "public"."bills"."order_type"::text, "public"."bills"."status"::text, "public"."bills"."customer_name", "public"."bills"."customer_phone", "public"."bills"."notes", "public"."bills"."billed_at", "public"."bills"."created_at", "public"."bills"."updated_at", "public"."bills"."cancelled_at" FROM "public"."bills" WHERE "public"."bills"."tenant_id" = $1 ORDER BY "public"."bills"."billed_at" DESC OFFSET $2
prisma:query SELECT "public"."bill_items"."id", "public"."bill_items"."bill_id", "public"."bill_items"."item_id", "public"."bill_items"."quantity", "public"."bill_items"."price", "public"."bill_items"."gst_rate", "public"."bill_items"."gst_amount", "public"."bill_items"."total_amount", "public"."bill_items"."created_at", "public"."bill_items"."updated_at" FROM "public"."bill_items" WHERE "public"."bill_items"."bill_id" IN ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11) OFFSET $12
prisma:query SELECT "public"."items"."id", "public"."items"."tenant_id", "public"."items"."category_id", "public"."items"."name", "public"."items"."description", "public"."items"."sku", "public"."items"."item_type"::text, "public"."items"."price", "public"."items"."gst_rate", "public"."items"."track_inventory", "public"."items"."inventory_mode"::text, "public"."items"."unit", "public"."items"."is_active", "public"."items"."created_at", "public"."items"."updated_at", "public"."items"."deleted_at" FROM "public"."items" WHERE "public"."items"."id" IN ($1,$2,$3,$4) OFFSET $5
prisma:query SELECT "public"."users"."id", "public"."users"."name", "public"."users"."email" FROM "public"."users" WHERE "public"."users"."id" IN ($1) OFFSET $2
prisma:query COMMIT
prisma:query BEGIN
prisma:query DEALLOCATE ALL
prisma:query SELECT "public"."bills"."id", "public"."bills"."tenant_id", "public"."bills"."user_id", "public"."bills"."kot_id", "public"."bills"."bill_number", "public"."bills"."subtotal", "public"."bills"."tax_amount", "public"."bills"."discount", "public"."bills"."total_amount", "public"."bills"."payment_method"::text, "public"."bills"."payment_status", "public"."bills"."order_type"::text, "public"."bills"."status"::text, "public"."bills"."customer_name", "public"."bills"."customer_phone", "public"."bills"."notes", "public"."bills"."billed_at", "public"."bills"."created_at", "public"."bills"."updated_at", "public"."bills"."cancelled_at" FROM "public"."bills" WHERE "public"."bills"."tenant_id" = $1 ORDER BY "public"."bills"."billed_at" DESC OFFSET $2
prisma:query SELECT "public"."bill_items"."id", "public"."bill_items"."bill_id", "public"."bill_items"."item_id", "public"."bill_items"."quantity", "public"."bill_items"."price", "public"."bill_items"."gst_rate", "public"."bill_items"."gst_amount", "public"."bill_items"."total_amount", "public"."bill_items"."created_at", "public"."bill_items"."updated_at" FROM "public"."bill_items" WHERE "public"."bill_items"."bill_id" IN ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11) OFFSET $12
prisma:query SELECT "public"."items"."id", "public"."items"."tenant_id", "public"."items"."category_id", "public"."items"."name", "public"."items"."description", "public"."items"."sku", "public"."items"."item_type"::text, "public"."items"."price", "public"."items"."gst_rate", "public"."items"."track_inventory", "public"."items"."inventory_mode"::text, "public"."items"."unit", "public"."items"."is_active", "public"."items"."created_at", "public"."items"."updated_at", "public"."items"."deleted_at" FROM "public"."items" WHERE "public"."items"."id" IN ($1,$2,$3,$4) OFFSET $5
prisma:query SELECT "public"."users"."id", "public"."users"."name", "public"."users"."email" FROM "public"."users" WHERE "public"."users"."id" IN ($1) OFFSET $2
prisma:query COMMIT